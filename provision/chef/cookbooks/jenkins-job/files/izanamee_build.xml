<flow-definition plugin="workflow-job@1.11"><actions/><description/><keepDependencies>false</keepDependencies><properties/><definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition" plugin="workflow-cps@1.11"><script>env.version = "2.1.${env.BUILD_NUMBER}"
env.kitchen = "/opt/chefdk/bin/kitchen"
headless_type = 'headless-tompscanlan-headless'
desktop_type = 'desktop-tompscanlan-desktop'
tests = false

stage 'checkout'
  node {
    git url: 'git@github.com:capitalone/Izanamee.git', branch: 'add_centos', credentialsId: '1e13511b-a440-4850-870d-e06ab4b1e06e'
    stash includes: '**', excludes: '*.box,provision/chef/vendor-cookbooks/**,packer_cache/**,output-virtualbox-iso/**,output-vmware-iso/**,base-virtualbox/**,base-vmware/**,output-virtualbox-ovf/**,output-vmware-vmx/**', name: 'source'
  }

parallel  'headless test': {
  node {
      if (tests == true) {
    unstash 'source'
    echo "headless got version ${env.version}"

    sh "${env.kitchen} create $headless_type"
    retry(3) {
      sh "${env.kitchen} converge $headless_type"
    }
    retry(3) {
      sh "${env.kitchen} verify $headless_type"
    }
      }
  }
},  'desktop test': {
  node {
    if (tests == true  )  {
    unstash 'source'
    echo "desktop got version ${env.version}"
    sh "${env.kitchen} create $desktop_type"
    retry(3) {
      sh "${env.kitchen} converge $desktop_type"
    }
    retry(3) {
      sh "${env.kitchen} verify $desktop_type"
    }
    }
  }
}

parallel 'headless build': {
  node {
    unstash 'source'
    sh "./packer/build-headless-boxes.sh"
    archive '*${headless_type}*${version}.box'
  }

}, 'desktop build': {
  node {
    unstash 'source'
    sh "./packer/build-desktop-boxes.sh"
    archive '*${desktop_type}*${version}.box'
  }
}</script><sandbox>false</sandbox></definition><triggers/></flow-definition>