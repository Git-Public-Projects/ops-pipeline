<flow-definition plugin="workflow-job@1.11"><actions/><description/><keepDependencies>false</keepDependencies><properties/><definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition" plugin="workflow-cps@1.11"><script>env.version = "2.1.${env.BUILD_NUMBER}"
env.kitchen = "/opt/chefdk/bin/kitchen"

stage 'checkout'
  node {
    git url: 'git@github.com:capitalone/Izanamee.git', branch: 'add_centos', credentialsId: '1e13511b-a440-4850-870d-e06ab4b1e06e'
    stash includes: '**', excludes: '*.box,provision/chef/vendor-cookbooks/**,packer_cache/**,output-virtualbox-iso/**,output-vmware-iso/**,base-virtualbox/**,base-vmware/**,output-virtualbox-ovf/**,output-vmware-vmx/**', name: 'source'
  }

parallel  'headless test': {
  node {
    type = 'headless-tompscanlan-headless'
    unstash 'source'
    echo "got version ${env.version}"

    sh "${env.kitchen} create $type"
    retry(3) {
      sh "${env.kitchen} converge $type"
    }
    retry(3) {
      sh "${env.kitchen} verify $type"
    }
  }
},  'desktop test': {
  node {
    type = 'desktop-tompscanlan-desktop'
    unstash 'source'
    sh "${env.kitchen} create $type"
    retry(3) {
      sh "${env.kitchen} converge $type"
    }
    retry(3) {
      sh "${env.kitchen} verify $type"
    }
  }
}

parallel 'headless build': {
  node {
    type = 'headless'
    unstash 'source'
    sh "./packer/build-${type}-boxes.sh"
    archive '*${type}*${version}.box'
  }

}, 'desktop build': {
  node {
    type = 'desktop'
    unstash 'source'
    sh "./packer/build-${type}-boxes.sh"
    archive '*${type}*${version}.box'
  }
}</script><sandbox>false</sandbox></definition><triggers/></flow-definition>